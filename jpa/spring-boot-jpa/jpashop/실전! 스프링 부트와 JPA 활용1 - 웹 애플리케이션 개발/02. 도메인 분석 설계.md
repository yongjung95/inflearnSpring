## 02. 도메인 분석 설계

### 도메인 모델과 테이블 설계
![img.png](../images/도메인%20모델.png)


### 엔티티 분석
![img.png](../images/회원%20엔티티%20분석.png)


### 테이블 분석
![img.png](../images/테이블%20분석.png)


### 연관관계 매핑 분석
- **회원과 주문**
  - 일대다, 다대일의 양방향 관계
  - 연관 관계의 주인은 **외래 키가 있는 주문을 연관 관계의 주인**으로 정한다.
- **주문상품과 주문**
  - 다대일 양방향 관계다.
  - 외래 키가 주문상품에 있으므로 **주문상품이 연관관계의 주인**이다.
- **주문상품과 상품**
  - 다대일 단방향 관계이다.
  - 외래 키가 주문상품에 있으므로 **주문상품이 연관관계의 주인**이다.
- **주문과 배송**
  - 일대일 양방향 관계이다.
  - 연관관계의 주인은 아무나 갖고 있어도 되지만, 여기서는 주문이 갖고 있다.
- **카테고리와 상품**
  - `@ManyToMany`를 사용했지만, 실무에서는 사용 금지 ❌


### 엔티티 설계시 주의점
- **값 타입은 변경 불가능하게 설계해야 한다**
  - `@Setter`를 제거하고, 생성자에서 값을 모두 초기화해서 변경 불가능한 클래스를 만들다.
  - JPA 스펙상 엔티티나 임베디드 타입(`@Embeddable`)은 자바 기본 생성자를 `public` 또는 `protected` 로 설정해야 한다.
  - 이유는 **JPA 구현 라이브러리가 객체를 생성할 때 리플랙션 같은 기술을 사용할 수 있도록 지원해야 하기 때문이다.**

- **엔티티는 가급적 Setter를 사용하지 말자**
  - `Setter`가 모두 열려있으면 변경 포인트가 너무 많고, 유지보수가 어렵다.

- **모든 연관관계는 지연로딩으로 설정!**
  - 즉시로딩(`EAGER`)은 예측이 어렵고, 어떤 SQL이 실행될 지 추적하기 어렵고 특히 JPQL를 실행할 때 N+1 문제가 자주 발생한다.
  - 실무에서는 모든 연관관계를 지연로딩(`LAZY`)으로 설정해야 한다.
  - 연관된 엔티티를 함께 DB에서 조회해야 하면, **fetch join 또는 엔티티 그래프 기능**을 사용한다.
  - `@XToOne(OneToOne, ManyToOne)`관계는 기본이 즉시로딩이므로 직접 지연로딩으로 설정해야 한다.

- **컬렉션은 필드에서 초기화하자**
  - 컬렉션은 필드에서 바로 초기화 하는 것이 `null` 문제에서 안전하다.
  - 하이버네이트는 엔티티를 영속화 할 때, 컬렉션을 감싸서 하이버네이트가 제공하는 내장 컬렉션으로 변경한다.
  - 만약 임의의 메서드에서 컬렉션을 잘못 생성하면 하이버네이트 내부 메커니즘에 문제가 발생할 수 있기에 필드레벨에서 생성하는 것이 가장 안전하고, 코드도 간결하다.
  - 