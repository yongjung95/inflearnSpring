# 8. 네트워크 - 프로그램2
## 셧다운 훅(Shutdown Hook)
- 자바는 프로세스가 종료될 때, 자원 정리나 로그 기록과 같은 종료 작업을 마무리 할 수 있는 셧다운 훅이라는 기능을 지원한다.
- 프로세스 종료는 크게 2가지로 분류할 수 있다.
  - 정상 종료
    - 모든 non 데몬 스레드의 실행 완료로 자바 프로세스 정상 종료
    - 사용자가 Ctrl+C를 눌러서 프로그램을 중단
    - kill 명령 전달 ( kill -9 제외)
    - IntelliJ의 stop 버튼
  - 강제 종료
    - 운영체제에서 프로세스를 더 이상 유지할 수 없다고 판단할 때 사용
    - 리눅스/유닉스의 kill -9 나 Windows의 taskkill /F


## 네트워크 예외 - 연결 예외
### java.net.UnknownHostException
- 호스트를 알 수 없음
- 999.999.999.999 : 이런 IP는 존재하지 않는다.
- google.gogo : 이런 도메인 이름은 존재하지 않는다.


### java.net.ConnectException: Connection refused
- Connection refused 메시지는 연결이 거절되었다는 뜻이다.
- 연결이 거절되었다는 것은, 우선은 네트워크를 통해 해당 IP의 서버 컴퓨터에 접속은 했다는 뜻이다.
- 그런데 해당 서버 컴퓨터가 45678 포트를 사용하지 않기 때문에 TCP 연결을 거절한다.
- IP에 해당하는 서버는 켜져있지만, 사용하는 PORT가 없을 때 주로 발생한다.
- 네트워크 방화벽 등에서 무단 연결로 인지하고 연결을 막을 때도 발생한다.
- 서버 컴퓨터의 OS는 이때 TCP RST(Reset)라는 패킷을 보내서 연결을 거절한다.
- 클라이언트가 연결 시도 중에 RST 패킷을 받으면 이 예외가 발생한다.


### TCP RST(Reset) 패킷
- TCP 연결에 문제가 있다는 뜻이다.
- 이 패킷을 받으면 받은 대상은 바로 연결을 해제해야 한다.


## 네트워크 예외 - 타임아웃
### OS 기본 대기 시간
- TCP 연결을 시도했는데 연결 응답이 없다면 OS에는 연결 대기 타임아웃이 설정되어 있다.
  - Windows: 약 21초
  - Linux: 약 75초에서 180초 사이
  - mac test 75초
- 해당 시간이 지나면 java.net.ConnectException: Operation timed out 이 발생한다.


### TCP 연결 타임아웃 - 직접 설정
- TCP 연결을 클라이언트가 이렇게 오래 대기하는 것은 좋은 방법이 아니다.
- 연결이 안되면 고객에게 빠르게 현재 연결에 문제가 있다고 알려주는 것이 더 나은 방법이다.
- `new Socket()`
  - Socket 객체를 생성할 때 인자로 IP, PORT를 모두 전달하면 생성자에서 바로 TCP 연결을 시도한다.
  - 하지만 IP, PORT를 모두 빼고 객체를 생성하면, 객체만 생성되고, 아직 연결은 시도하지 않는다.
  - 추가적으로 필요한 설정을 더 한 다음에 `socket.connect()` 를 호출하면 그때 TCP 연결을 시도한다.
  - 이 방식을 사용하면 추가적인 설정을 더 할 수 있는데, 대표적으로 타임아웃을 설정할 수 있다.


### TCP 소켓 타임아웃 - read 타임아웃
- 연결이 잘 된 이후에 클라이언트가 서버에 어떤 요청을 했다고 가정하자. 그런데 서버가 계속 응답을 주지 않는다면, 무한정 기다려야 하는 것일까?
- 서버에 사용자가 폭주하고 매우 느려져서 응답을 계속 주지 못하는 상황이라면 어떻게 해야할까?
- `socket.setSoTimeout()`
  - 사용하면 밀리초 단위로 타임아웃 시간을 설정할 수 있다.
  - 시간이 지나면 java.net.SocketTimeoutException: Read timed out 예외가 발생한다.


## 네트워크 예외 - 정상 종료
- TCP에서 A, B가 서로 통신한다고 가정해보자.
- TCP 연결을 종료하려면 서로 FIN 메시지를 보내야 한다.
  - A (FIN) B: A가 B로 FIN 메시지를 보낸다.
  - A (FIN) B: FIN 메시지를 받은 B도 A에게 FIN 메시지를 보낸다.
- `socket.close()` 를 호출하면 TCP에서 종료의 의미인 FIN 패킷을 상대방에게 전달한다.
- FIN 패킷을 받으면 상대방도 `socket.close()` 를 호출해서 FIN 패킷을 상대방에게 전달해야 한다.


## 네트워크 예외 - 강제 종료
- TCP 연결 중에 문제가 발생하면 RST 라는 패킷이 발생한다. 
  - 이 경우 연결을 즉시 종료해야 한다.
- RST 패킷이 도착했다는 것은 현재 TCP 연결에 심각한 문제가 있으므로 해당 연결을 더는 사용하면 안된다는 의미이다.


### 참고 - RST(Reset)
- TCP에서 RST 패킷은 연결 상태를 초기화(리셋)해서 더 이상 현재의 연결을 유지하지 않겠다는 의미를 전달한다. 
  - 여기서 "Reset"은 현재의 세션을 강제로 종료하고, 연결을 무효화하라는 뜻이다.
- RST 패킷은 TCP 연결에 문제가 있는 다양한 상황에 발생한다. 예를 들어서 다음과 같은 경우들이 있다.
  - TCP 스펙에 맞지 않는 순서로 메시지가 전달될 때
  - TCP 버퍼에 있는 데이터를 아직 다 읽지 않았는데, 연결을 종료할 때
  - 방화벽 같은 곳에서 연결을 강제로 종료할 때도 발생한다.


### 정리
- 상대방이 연결을 종료한 경우 데이터를 읽으면 EOF가 발생한다.
  - -1, null , EOFException 등이 발생한다.
  - 이 경우 연결을 끊어야 한다.
- java.net.SocketException: Connection reset
  - RST 패킷을 받은 이후에 read() 호출
  - 윈도우 오류 메시지: 현재 연결은 사용자의 호스트 시스템의 소프트웨어의 의해 중단되었습니다
- java.net.SocketException: Broken pipe
  - RST 패킷을 받은 이후에 write() 호출
  - 윈도우 오류 메시지: 현재 연결은 사용자의 호스트 시스템의 소프트웨어의 의해 중단되었습니다
- java.net.SocketException: Socket is closed
  - 자신이 소켓을 닫은 이후에 read() , write() 호출