# 06. 동기화 - synchronized

## 멀티스테드를 사용할 때 가장 주의해야 할 점
- 같은 자원(리소스)에 여러 스레드가 동시에 접근할 때 발생하는 동시성 문제이다.
  - 참고로 여러 스레드가 접근하는 자원을 **공유 자원**이라 한다.
  - 대표적인 공유 자원은 인스턴스의 필드(멤버 변수)이다.


## 임계 영역(critical section)
- 여러 스레드가 동시에 접근하면 데이터 불일치나 예상치 못한 동작이 발생할 수 있는 위험하고 또 중요한 코드 부분을 뜻한다.
- 여러 스레드가 동시에 접근해서는 안 되는 공유 자원을 접근하거나 수정하는 부분을 의미한다.
  - 예) 공유 변수나 공유 객체를 수정


## synchronized 메서드
- 모든 객체(인스턴스)는 내부에 자신만의 락(lock)을 가지고 있다.
  - 모니터 락(monitor lock)이라고도 부른다.
  - 객체 내부에 있고 우리가 확인하기는 어렵다.
  - 자바에서 기본으로 제공한다.
- 스레드가 **synchronized** 키워드가 있는 메서드에 접근하려면 반드시 해당 인스턴스의 락이 있어야 한다.


### 참고
- **락을 획득하는 순서는 보장되지 않는다.**
  - 어떤 순서로 락을 획득하는지는 자바 표준에 정의되어 있지 않다.
  - 따라서 순서를 보장하지 않고, 환경에 따라 순서가 달라질 수 있다.
- **volatile를 사용하지 않아도 synchronized 안에서 접근하는 변수의 메모리 가시성 문제는 해결된다.**


## synchronized 동기화 정리
### 메서드 동기화
- 메서드를 **synchronized**로 선언해서, 메서드에 접근하는 스레드가 하나뿐이도록 보장한다.


### 블록 동기화
- 코드 블록을 **synchronized**로 감싸서, 동기화를 구현할 수 있다.


### 동기화의 장점
- 경합 조건(Race condition)
  - 두 개 이상의 스레드가 경쟁적으로 동일한 자원을 수정할 때 발생하는 문제.
- 데이터 일관성
  - 여러 스레드가 동시에 읽고 쓰는 데이터의 일관성을 유지


### 동기화 주의
- 동기화는 멀티스레드 환경에서 필수적인 기능이지만, 과도하게 사용할 경우 **성능 저하를 초래할 수 있으므로 꼭 필요한 곳에 적절히 사용**해야 한다.


## 정리
- 자바는 처음부터 멀티스레드를 고려하고 나온 언어이다.
- 그래서 자바 1.0 부터 **synchronized** 같은 동기화 방법을 프로그래밍 언어의 문법에 포함해서 제공한다.


### synchronized 장점
- 프로그래밍 언어에 문법으로 제공
- 아주 편리한 사용
- **자동 장금 해제**
  - **synchronized** 메서드나 블록이 완료되면 자동으로 락을 대기중인 다른 스레드의 잠금이 해제된다.
  - 개발자가 직접 특정 스레드를 깨우도록 관리해야 한다면, 매우 어렵고 번거로울 것이다.


### synchronized 단점
- 제공하는 기능이 너무 단순하다.
  - 시간이 지나면서 멀티스레드가 더 중요해지고 점점 더 복잡한 동시성 개발 방법들이 필요해졌다.
- 무한 대기
  - **BLOCKED** 상태의 스레드는 락이 풀릴 때까지 무한 대기한다.
  - 특정 시간까지만 대기하는 타임아웃 ❌
  - 중간에 인터럽트 ❌
- 공정성
  - 락이 돌아왔을 때 **BLOCKED** 상태의 여러 스레드 중에 어떤 스레드가 락을 획득할 지 알 수 없다.
  - 최악의 경우 특정 스레드가 너무 오랜기간 락을 획득하지 못할 수 있다.