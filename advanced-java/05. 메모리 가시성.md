## 05. 메모리 가시성

## 실제 메모리의 접근 방식
![img.png](images/실제%20메모리의%20접근%20방식.png)
- CPU는 처리 성능을 개선하기 위해 중간에 **캐시 메모리**라는 것을 사용한다.


### 캐시 메모리를 메인 메모리에 반영하거나, 메인 메모리의 변경 내역을 캐시 메모리에 다시 불러오는 것은 언제 발생할까?
- 이 부분은 CPU 설계 방식과 실행 환경에 따라 다를 수 있다.
  - 즉시 반영될 수도 있고, 몇 밀리초 후에 될 수도 있고, 몇 초 후에 될 수도 있고, 평생 반영되지 않을 수도 있다.
- 주로 컨텍스트 스위칭이 될 때, 캐시 메모리도 함께 갱신되는데, 이 부분도 환경에 따라 달라질 수 있다.
  - 예) **Thread.sleep()** 이나 콘솔에 내용을 출력할 때 스레드가 잠시 쉬는데, 이럴 때 **컨텍스트 스위칭**이 되면서 주로 갱신된다.
  - 하지만 **이것이 갱신을 보장하는 것은 아니다.**


## 메모리 가시성
- 멀티스레드 환경에서 한 스레드가 변경한 값이 다른 스레드에서 언제 보이는지에 대한 문제를 **메모리 가시성**이라 한다.
  - 이름 그대로 메모리에 변경한 값이 보이는가, 보이지 않는가의 문제이다.


## volatile
- 캐시 메모리를 사용하면 CPU 처리 성능을 개선할 수 있다.
  - 하지만 때로는 이런 성능 향상보다는, 여러 스레드에서 같은 시점에 정확히 같은 데이터를 보는 것이 더 중요할 수 있다.
- **volatile** 는 성능을 약간 포기하는 대신에, 값을 읽을 때, 값을 쓸 때 모두 **메인 메모리에 직접 접근**해서 사용한다.