## 05. 메모리 가시성

## 실제 메모리의 접근 방식
![img.png](images/실제%20메모리의%20접근%20방식.png)
- CPU는 처리 성능을 개선하기 위해 중간에 **캐시 메모리**라는 것을 사용한다.


### 캐시 메모리를 메인 메모리에 반영하거나, 메인 메모리의 변경 내역을 캐시 메모리에 다시 불러오는 것은 언제 발생할까?
- 이 부분은 CPU 설계 방식과 실행 환경에 따라 다를 수 있다.
  - 즉시 반영될 수도 있고, 몇 밀리초 후에 될 수도 있고, 몇 초 후에 될 수도 있고, 평생 반영되지 않을 수도 있다.
- 주로 컨텍스트 스위칭이 될 때, 캐시 메모리도 함께 갱신되는데, 이 부분도 환경에 따라 달라질 수 있다.
  - 예) **Thread.sleep()** 이나 콘솔에 내용을 출력할 때 스레드가 잠시 쉬는데, 이럴 때 **컨텍스트 스위칭**이 되면서 주로 갱신된다.
  - 하지만 **이것이 갱신을 보장하는 것은 아니다.**


## 메모리 가시성
- 멀티스레드 환경에서 한 스레드가 변경한 값이 다른 스레드에서 언제 보이는지에 대한 문제를 **메모리 가시성**이라 한다.
  - 이름 그대로 메모리에 변경한 값이 보이는가, 보이지 않는가의 문제이다.


## volatile
- 캐시 메모리를 사용하면 CPU 처리 성능을 개선할 수 있다.
  - 하지만 때로는 이런 성능 향상보다는, 여러 스레드에서 같은 시점에 정확히 같은 데이터를 보는 것이 더 중요할 수 있다.
- **volatile** 는 성능을 약간 포기하는 대신에, 값을 읽을 때, 값을 쓸 때 모두 **메인 메모리에 직접 접근**해서 사용한다.


## 자바 메모리 모델 (Java Memory Model)

### Java Memory Model
- 자바 프로그램이 어떻게 메모리에 접근하고 수정할 수 있는지를 규정하며, 특히 멀티 스레드 프로그래밍에서 스레드 간의 상호작용을 정의한다.
- 여러가지 내용이 있지만, 핵심은 **여러 스레드들의 작업 순서를 보장하는 happens-before** 관계에 대한 정의이다.


### happens-before
- 자바 메모리 모델에서 스레드 간의 작업 순서를 정의하는 개념이다.
  - 예) A 작업이 B 작업 보다 happens-before 관계에 있다면, A 작업에서의 모든 메모리 변경 사항은 B 작업에서 볼 수 있다.
  - 즉, A 작업에서 변경된 내용은 B 작업이 시작되기 전에 모두 메모리에 반영된다.
- happens-before 관계는 이름 그대로, 한 동작이 다른 동작보다 먼저 발생함을 보장한다.
- happens-before 관계는 스레드 간의 메모리 가시성을 보장하는 규칙이다.
- happens-before 관계가 성립하면, 한 스레드의 작업을 다른 스레드에서 볼 수 있게 된다.
- 즉, 한 스레드에서 수행한 작업을 다른 스레드가 참조할 때 최신 상태가 보장되는 것이다.


### happens-before 관계가 발생하는 경우
- 프로그램 순서 규칙
  - 단일 스레드 내에서, 프로그램의 순서대로 작성된 모든 명령문은 happens-before 순서로 실행된다.
- volatile 변수 규칙
  - 한 스레드에서 **volatile** 변수에 대한 쓰기 작업은 해당 변수를 읽는 모든 스레드에 보이도록 한다.
    - 즉, **volatile** 변수에 대한 쓰기 작업은 그 변수를 읽는 작업보다 **happens-before** 관계를 형성한다.
- 스레드 시작 규칙
  - 한 스레드에서 **Thread.start()** 를 호출하면, 해당 스레드 내의 모든 작업은 **start()** 호출 이후에 실행된 작업보다 **happens-before** 관계가 성립한다.
  - 여기에서 **start()** 호출 전에 수행된 모든 작업은 새로운 스레드가 시작된 후의 작업보다 **happens-before** 관계를
가진다.
- 스레드 종료 규칙
  - 스레드에서 **Thread.join()** 을 호출하면, join 대상 스레드의 모든 작업은 **join()** 이 반환된 후의 작업보다
**happens-before** 관계를 가진다. 
  - 예) **thread.join()** 호출 전에 **thread** 의 모든 작업이 완료되어야 하며, 이 작업은 **join()** 이 반환된 후에 참조 가능하다.
- 인터럽트 규칙
  - 한 스레드에서 **Thread.interrupt()** 를 호출하는 작업이, 인터럽트된 스레드가 인터럽트를 감지하는 시점의 작업
보다 **happens-before** 관계가 성립한다. 
  - 즉, **interrupt()** 호출 후, 해당 스레드의 인터럽트 상태를 확인하는 작업이 **happens-before** 관계에 있다. 
  - 만약 이런 규칙이 없다면 인터럽트를 걸어도, 한참 나중에 인터럽트가 발생할 수 있다.
- 객체 생성 규칙
- 모니터 락 규칙
- 전이 규칙