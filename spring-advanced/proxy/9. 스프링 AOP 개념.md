## 9. 스프링 AOP 개념

### AOP 소개 - 애스팩트
- 부가 기능과 부가 기능을 어디에 적용할지 선택하는 기능을 합해서 하나의 **모듈**로 만든 것.
- 쉽게 이야기해서 부가 기능과 해당 부가 기능을 어디에 적용할 지 정의한 것.
- 예) 로그 출력 기능을 모든 컨트롤러에 적용해라 라는 것이 정의 되어 있다.
- 스프링이 제공하는 **어드바이저**도 **어드바이스(부가 기능)** 과 **포인트컷(적용 대상)** 을 가지고 있어서 개념상 하나의 **애스펙트**이다.
- **애스펙트를 사용한 프로그래밍 방식을 관점 지향 프로그래밍 AOP(Aspect-Oriented Programming)** 이라고 한다

### AspectJ 프레임워크
- **AOP**의 대표적인 구현이다.
- 스프링도 **AOP**를 지원하지만 대부분 **AspectJ**의 문법을 차용하고, **AspectJ**가 제공하는 기능의 일부만 제공한다.
- 자바 프로그래밍 언어에 대한 완벽한 관점 지향 확장
- 횡단 관심사의 깔끔한 모듈화
  - 오류 검사 및 처리
  - 동기화
  - 성능 최적화(캐싱)
  - 모니터링 및 로깅


### AOP 적용 방식
#### 컴파일 시점
![img_1.png](images/컴파일%20시점.png)
- **.java** 소스 코드를 컴파일러를 사용해서 **.class**를 만드는 시점에 부가 기능 로직을 추가할 수 있다.
- 이때 **AspectJ**가 제공하는 특별한 컴파일러를 사용해야 한다.
- 부가 기능 코드가 핵심 기능이 있는 컴파일된 코드 주변에 실제로 붙어버린다.
- 이렇게 원본 로직에 부가 기능이 추가되는 것을 **위빙(Weaving)**이라 한다.
- 단점
  - 컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러도 필요하고 복잡하다.


#### 클래스 로딩 시
![img.png](images/클래스%20로딩%20시점.png)
- 자바를 실행하면 자바 언어는 **.class** 파일을 **JVM** 내부의 클래스 로더에 보관한다.
- 이때 중간에서 **.class** 파일을 조작한 다음 **JVM**에 올릴 수 있다.
- 자바 언어는 **.class**를 **JVM**에 저장하기 전에 조작할 수 있는 기능을 제공한다.
- 이 시점에 에스펙트를 적용하는 것을 **로드 타임 위빙**이라 한다.
- 단점
  - 로드 타임 위빙은 자바를 실행할 때 특별한 옵션(**java -javaagent**)을 통해 클래스 로더 조작지를 지정해야 하는데, 이 부분이 번거롭고 운영하기 어렵다.


#### 런타임 시점
![img.png](images/런타임%20시점.png)
- 런타임 시점은 컴파일도 다 끝나고, 클래스 로더에 클래스도 다 올라가서 이미 자바가 실행되고 난 다음을 말한다.
- 스프링과 같은 컨테이너의 도움을 받고 **프록시**와 **DI**,**빈 포스트 프로세서** 같은 개념들을 총 동원해야 한다.
- 이렇게 하면 최종적으로 **프록시**를 통해 **스프링 빈**에 부가 기능을 적용할 수 있다.
- **프록시**를 사용하기 때문에, **AOP** 기능에 일부 제약이 있지만, 특별한 컴파일러나 자바를 실행할 때 복잡한 옵션과 클래스 로더 조작기를 설정하지 않아도 된다.
- 스프링만 있으면 얼마든지 **AOP**를 적용할 수 있다.


### 정리
- 컴파일 시점
  - 실제 대상 코드에 **애스펙트**를 통한 부가 기능 호출 코드가 포함된다.
  - **AspectJ**를 직접 사용해야 한다.
- 클래스 로딩 시점
  - 실제 대상 코드에 **애스펙트**를 통한 부가 기능 호출 코드가 포함된다.
  - **AspectJ**를 직접 사용해야 한다.
- 런타임 시점
  - 실제 대상 코드는 그대로 유지되고, **프록시**를 통해 부가 기능이 적용된다.
  - 항상 **프록시**를 통해야 부가 기능을 사용할 수 있다.
  - **스프링 AOP**는 이 방식을 사용한다.


### AOP 적용 위치
- 컴파일 시점
  - **AspectJ**를 사용해서 바이트코드를 실제 조작하기 때문에 해당 기능을 모든 지점에 다 적용할 수 있다.
- 클래스 로딩 시점
  - **AspectJ**를 사용해서 바이트코드를 실제 조작하기 때문에 해당 기능을 모든 지점에 다 적용할 수 있다.
- 프록시 방식을 사용하는 **스프링 AOP**
  - **프록시**는 메서드 오버라이등 개념으로 동작하기 때문에, **메서드 실행으로 제한**된다.
  - **스프링 컨테이너**가 관리할 수 있는 **스프링 빈에만 AOP를 적용**할 수 있다.


### AOP 용어 정리
- **조인 포인트(Join point)**
  - **어드바이스**가 적용될 수 있는 위치, 메소드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근 같은 프로그램 실행 중 지점 
  - 조인 포인트는 추상적인 개념이다. **AOP**를 적용할 수 있는 모든 지점이라 생각하면 된다. 
  - **스프링 AOP**는 **프록시** 방식을 사용하므로 조인 포인트는 항상 메소드 실행 지점으로 제한된다. 
- **포인트컷(Pointcut)**
  - 조인 포인트 중에서 **어드바이스**가 적용될 위치를 선별하는 기능 
  - 주로 **AspectJ** 표현식을 사용해서 지정
  - **프록시**를 사용하는 **스프링 AOP**는 메서드 실행 지점만 포인트컷으로 선별 가능 
- **타켓(Target)**
  - **어드바이스**를 받는 객체, **포인트컷**으로 결정 
- **어드바이스(Advice)**
  - 부가 기능 
  - 특정 조인 포인트에서 **Aspect**에 의해 취해지는 조치 
  - Around(주변), Before(전), After(후)와 같은 다양한 종류의 어드바이스가 있음 
- **애스펙트(Aspect)**
  - **어드바이스** + **포인트컷**을 모듈화 한 것 
  - **@Aspect** 를 생각하면 됨 
  - 여러 **어드바이스**와 **포인트컷**이 함께 존재 
- **어드바이저(Advisor)**
  - 하나의 **어드바이스**와 하나의 **포인트컷**으로 구성 
  - **스프링 AOP**에서만 사용되는 특별한 용어 
- **위빙(Weaving)**
  - **포인트컷**으로 결정한 타켓의 조인 포인트에 **어드바이스**를 적용하는 것 
  - 위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가 할 수 있음 
  - **AOP** 적용을 위해 애스펙트를 객체에 연결한 상태 
    - 컴파일 타임(AspectJ compiler)
    - 로드 타임 
    - 런타임, **스프링 AOP**는 런타임, 프록시 방식 
- **AOP 프록시**
  - **AOP** 기능을 구현하기 위해 만든 **프록시** 객체, 스프링에서 **AOP 프록시**는 **JDK 동적 프록시 또는 CGLIB 프록시**이다.
