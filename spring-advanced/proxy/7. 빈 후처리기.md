## 7. 빈 후처리기

### 빈 후처리기
#### 빈 후처리기란?
- 빈을 생성한 후에 무언가를 처리하는 용도로 사용한다.


#### 빈 후처리기 기능
- 객체를 조작할 수도 있고, 완전히 다른 객체로 바꿔치기 하는 것도 가능하다.


#### 빈 후처리기 과정
![img.png](images/빈%20후처리기%20과정.png)
1. 생성 : 스프링 빈 대상이 되는 객체를 생성한다. (**Bean**, 컴포넌트 스캔 모두 포함)
2. 전달 : 생성된 객체를 빈 저장소에 등록하기 직전에 빈 후처리기에 전달한다.
3. 후 처리 작업 : **빈 후처리기**는 전달된 스프링 빈 객체를 조작하거나 다른 객체로 바꿔치기 할 수 있다.
4. 등록 : **빈 후처리기**는 빈을 반환한다. 전달된 빈을 그대로 반환한하면 해당 빈이 등록되고, 바꿔치기 하면 다른 객체가 빈 저장소에 등록된다.

#### 다른 객체로 바꿔치는 빈 후처리기
- 스프링 빈 등록 과정 - 바꿔치기
![img_1.png](images/다른%20객체로%20바꿔치는%20빈%20후처리기.png)


#### 빈 후처리기 사용법
```java
public interface BeanPostProcessor {
 Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException
 Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException
}
```
- **빈 후처리기**를 사용하려면 **BeanPostProcessor** 인터페이스를 구현하고, 스프링 빈으로 등록하면 된다.
- **postProcessBeforeInitialization**
  - 객체 생성 이후에 **@PostConstruct** 같은 초기화가 발생하기 전에 호출되는 포스트 프로세서이다.
- **postProcessAfterInitialization**
  - 객체 생성 이후에 **@PostConstruct** 같은 초기화가 발생한 다음에 호출되는 포스트 프로세서이다.


#### 빈 후처리기 정리
- **빈 후처리기**는 빈을 조작하고 변경할 수 있는 후킹 포인트이다.
- 빈 객체를 조작하거나 심지어 다른 객체로 바꾸어 버릴 수 있을 정도로 막강하다.
- 컴포넌트 스캔의 대상이 되는 빈들은 중간에 조작할 방법이 없는데, **빈 후처리기**를 사용하면 개발자가 등록하는 모든 빈을 중간에 조작할 수 있다.
- **빈 객체를 프록시로 교체**하는 것도 가능하다.


### 스프링이 제공하는 빈 후처리기
#### 자동 프록시 생성기 - AutoProxyCreator
- 스프링 부트 자동 설정으로 **AnnotationAwareAspectJAutoProxyCreator** 라는 **빈 후처리기**가 스프링 빈에 자동으로 등록된다.
- 스프링 빈으로 등록된 **Advisor**들을 자동으로 찾아서 프록시가 필요한 곳에 자동으로 프록시를 적용해준다.
- **Advisor**안에는 **Pointcut**과 **Advice**가 이미 모두 포함되어 있기 때문에, 
**Advisor**만 알고 있으면 그 안에 있는 **Pointcut**으로 어떤 스프링 빈에 프록시를 적용해야 할지 알 수 있고, **Advice**로 부가 기능을 적용하면 된다.


#### 자동 프록시 생성기의 작동 과정
![img.png](images/자동%20프록시%20생성기의%20작동%20과정.png)
1. 생성 : 스프링이 스프링 빈 대상이 되는 객체를 생성한다.(**@Bean**, 컴포넌트 스캔 모두 포함)
2. 전달 : 생성된 객체를 빈 저장소에 등록하기 직전에 **빈 후처리기**에 전달한다.
3. 모든 **Advisor** 빈 조회 : 자동 프록시 생성기 - **빈 후처리기**는 스프링 컨테이너에서 모든 **Advisor**를 조회한다.
4. 프록시 적용 대상 체크 : 앞서 조회한 **Advisor**에 포함되어 있는 **포인트컷**을 사용해서 해당 객체가 프록시 적용 대상인지 파악한다.
   - 이때 객체의 클래스 정보는 물론이고, 모든 메서드를 **포인트컷**에 하나하나 모두 매칭 후, 조건이 하나라도 만족하면 프록시 적용 대상이 된다.
5. 프록시 생성 : 프록시 적용 대상이면 프록시를 생성하고, 반환해서 프록시를 스프링 빈으로 등록한다. (이때 적용 대상이 아니라면 원본 객체를 반환한다.)
6. 빈 등록 : 반환된 객체는 스프링 빈으로 등록된다.


#### 중요: 포인트컷은 2가지에 사용된다.
1. 프록시 적용 여부 판단 - 생성 단계 (객체 생성)
   - **자동 프록시 생성기**는 **포인트컷**을 사용해서 해당 빈이 프록시를 생성할 필요가 있는지 없는지 체크한다.
   - 클래스 + 메서드 조건을 모두 비교한 후, **포인트컷** 조건에 하나하나 매칭을 한 다음 조건에 맞는 것이 하나라도 있으면 프록시를 생성한다.
   - 만약 조건에 맞는 것이 하나도 없으면 프록시를 생성할 필요가 없으므로 프록시를 생성하지 않는다.
2. 어드바이스 적용 여부 판단 - 사용 단계 (실제 객체 사용)
   - 프록시가 호출되었을 때 부가 기능인 **어드바이스**를 적용할지 말지 **포인트컷**을 보고 판단한다.
     - **포인트컷** 조건에 만족하면 프록시는 **어드바이스**를 호출 후, **target**을 호출한다.
     - **포인트컷** 조건에 만족하지 않으면, **어드바이스**를 호출하지 않고 바로 **target**을 호출한다.